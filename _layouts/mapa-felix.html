<!DOCTYPE html>
<html>

<head>
    {% include head.html %}
    {% include meta.html %}
    
  <meta charset="utf-8" />
  <title>Mapa Bizanet</title>
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
<link rel="stylesheet" href="{{ site.baseurl }}/css/map_style_boiada.css">
  <!-- Google fonts-->
  <link rel="stylesheet" type="text/css" href="//fonts.googleapis.com/css?family=Open+Sans" />

  <meta name="viewport" content="initial-scale=1,maximum-scale=1,user-scalable=no"/>

  <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
  <script src="https://api.mapbox.com/mapbox-gl-js/v1.9.1/mapbox-gl.js"></script>
  <link href="https://api.mapbox.com/mapbox-gl-js/v1.9.1/mapbox-gl.css" rel="stylesheet" />
  <script src="https://npmcdn.com/csv2geojson@latest/csv2geojson.js"></script>
  <script src="https://npmcdn.com/@turf/turf/turf.min.js"></script>
  <script src="https://api.mapbox.com/mapbox-gl-js/plugins/mapbox-gl-geocoder/v4.0.0/mapbox-gl-geocoder.min.js"></script>
  <link rel="stylesheet" href="https://api.mapbox.com/mapbox-gl-js/plugins/mapbox-gl-geocoder/v4.0.0/mapbox-gl-geocoder.css" type="text/css" />
  
</head>

  <div id="left"></div>
  <div id="right"></div>
  <div id="top"></div>
  <div id="bottom"></div>
    
<body>
  
<div id="map"></div>
  
  <script>
    var geocoder = new MapboxGeocoder({
       accessToken: mapboxgl.accessToken,
       mapboxgl: mapboxgl
    });
    
    var transformRequest = (url, resourceType) => {
      var isMapboxRequest =
        url.slice(8, 22) === "api.mapbox.com" ||
        url.slice(10, 26) === "tiles.mapbox.com";
      return {
        url: isMapboxRequest
          ? url.replace("?", "?pluginName=sheetMapper&")
          : url
      };
    };
      
    mapboxgl.accessToken = 'pk.eyJ1Ijoic2FyYWxnYyIsImEiOiJja2NjbTAyczkwNXA3Mnlscm5nbjN5OHZiIn0.yNcJkPBSugRlIeGkXDRlZw'; //Mapbox token 
      
    var map = new mapboxgl.Map({
      container: 'map', // container id
      style: 'mapbox://styles/saralgc/cko1yjkz115zq18qqk55fslpg',
      center: [2.869932, 43.165596], // starting position
      zoom: 16,// starting zoom
      transformRequest: transformRequest
    });
    
    $(document).ready(function () {
      $.ajax({
        type: "GET",
        //YOUR TURN: Replace with csv export link
        //https://www.mapbox.com/impact-tools/sheet-mapper
       url:'https://docs.google.com/spreadsheets/d/1mF4WKNlJw-FN7IYjszle1EuQhmhWuI2XJNM_lT5kBoo/gviz/tq?tqx=out:csv&sheet=Sheet1',
        dataType: "text",
        success: function (csvData) { makeGeoJSON(csvData); }
      });



      function makeGeoJSON(csvData) {
        csv2geojson.csv2geojson(csvData, {
          latfield: 'Latitude',
          lonfield: 'Longitude',
          delimiter: ','
        }, function (err, data) {
          
          map.on('load', function () {
            
            map.loadImage(
             '../assets/favicons/vaca-rosa2.png',
              function(error, image) {
              if (error) throw error;
              map.addImage('camera', image);
            });
            
            map.addLayer({
              'id': 'csvData',
              'type': 'symbol',
              'source': {
                'type': 'geojson',
                'data': data
              },
              'layout': {
                'icon-image': 'camera',
                'icon-anchor': 'bottom', // point of the icon which will correspond to marker's location
                "icon-allow-overlap": true,
                //'icon-size': 0.025
              }
             });

            // When a click event occurs on a feature in the csvData layer, open a popup at the
            // location of the feature, with description HTML from its properties.
            
            map.on('click', 'csvData', function (e) {
              var coordinates = e.features[0].geometry.coordinates.slice();

               var description = `<audio controls style="width:100%;" controlsList="nodownload" autoplay><source src="../assets/sounds/` + e.features[0].properties.Audio + `.mp3" type="audio/mpeg"></audio>` + `<h2>` + e.features[0].properties.Titulo + `</h2>`;
                
              while (Math.abs(e.lngLat.lng - coordinates[0]) > 180) {
              coordinates[0] += e.lngLat.lng > coordinates[0] ? 360 : -360;
              }
                
              //add Popup to map
              new mapboxgl.Popup()
                .setLngLat(coordinates)
                .setHTML(description)
                .addTo(map);
            });
          
            var bbox = turf.bbox(data);
           // map.fitBounds(bbox, { padding: 50 });
         map.setLayoutProperty('csvData', 'icon-size', 
            ['interpolate', ['linear'], ['zoom'],
              0,
              //TAMANHO AO ZOOM 0
              0.08,
              6,
              //TAMANHO AO ZOOM 7
              0.09,
              15,
              0.12,
              24,
              //TAMANHO AO ZOOM 24
              0.17
            ]);
          });

        });
      };
      
      
    });
    map.on('load', function () {
            map.addSource('route', {
                'type': 'geojson',
                'data': {
                    'type': 'Feature',
                    'properties': {},
                    'geometry': {
                        'type': 'LineString',
                        'coordinates': 
                        /*[
                                [2.869932, 43.163596], //fontaine de leglise
                                [2.870409, 43.164296], //font trompe loeil
                                [2.873231, 43.167360], //petit lavoir
                                [2.870613, 43.168078], //Ruisseau
                                [2.868773, 43.167726], //Lac
                                [2.868118, 43.166489], //cAVE COOPE
                                [2.867620, 43.163953], //JARDIN COMUNEUX
                                [2.871359, 43.162879],//grand lavoir
                        ]*/
                          [ 
                              [ 2.86985, 43.16362 ], [ 2.86988, 43.16368 ], [ 2.8699, 43.16374 ], [ 2.86993, 43.1638 ], [ 2.86995, 43.16385 ], [ 2.86997, 43.16388 ], [ 2.87001, 43.16393 ], [ 2.87014, 43.16404 ], [ 2.87027, 43.16416 ], [ 2.87037, 43.16424 ], [ 2.87041, 43.16427 ], [ 2.87048, 43.16433 ], [ 2.87071, 43.16451 ], [ 2.87073, 43.16453 ], [ 2.87089, 43.16466 ], [ 2.87093, 43.16469 ], [ 2.87105, 43.1648 ], [ 2.87109, 43.16484 ], [ 2.87117, 43.16492 ], [ 2.87123, 43.165 ], [ 2.87124, 43.16502 ], [ 2.87129, 43.16512 ], [ 2.87135, 43.16514 ], [ 2.87143, 43.16516 ], [ 2.87151, 43.16519 ], [ 2.8716, 43.16522 ], [ 2.87165, 43.16525 ], [ 2.87172, 43.1653 ], [ 2.87177, 43.16533 ], [ 2.87184, 43.1654 ], [ 2.87187, 43.16543 ], [ 2.87195, 43.16552 ], [ 2.87201, 43.16557 ], [ 2.87202, 43.16558 ], [ 2.87205, 43.16562 ], [ 2.87211, 43.16569 ], [ 2.87228, 43.16591 ], [ 2.87234, 43.16598 ], [ 2.87241, 43.16605 ], [ 2.87251, 43.16616 ], [ 2.87254, 43.16622 ], [ 2.87258, 43.16634 ], [ 2.87264, 43.16648 ], [ 2.87266, 43.16653 ], [ 2.87266, 43.16656 ], [ 2.87271, 43.16663 ], [ 2.87274, 43.16669 ], [ 2.87276, 43.16672 ], [ 2.87279, 43.16678 ], [ 2.87281, 43.16683 ], [ 2.87285, 43.16689 ], [ 2.8729, 43.16696 ], [ 2.87297, 43.16704 ], [ 2.87301, 43.1671 ], [ 2.87308, 43.16717 ], [ 2.8731, 43.1672 ], [ 2.87326, 43.16727 ], [ 2.87313, 43.16728 ], [ 2.87297, 43.16727 ], [ 2.87285, 43.16725 ], [ 2.87286, 43.16728 ], [ 2.8729, 43.1673 ], [ 2.87293, 43.16732 ], [ 2.87298, 43.16734 ], [ 2.87303, 43.16737 ], [ 2.87309, 43.1674 ], [ 2.87303, 43.16737 ], [ 2.87298, 43.16734 ], [ 2.87293, 43.16732 ], [ 2.8729, 43.1673 ], [ 2.87286, 43.16728 ], [ 2.87285, 43.16725 ], [ 2.87282, 43.16724 ], [ 2.87266, 43.16719 ], [ 2.87244, 43.16729 ], [ 2.87214, 43.16744 ], [ 2.87184, 43.16759 ], [ 2.8718, 43.16762 ], [ 2.87151, 43.16777 ], [ 2.87138, 43.16783 ], [ 2.87128, 43.16788 ], [ 2.87109, 43.16794 ], [ 2.87102, 43.168 ], [ 2.87095, 43.16803 ], [ 2.87086, 43.16806 ], [ 2.87072, 43.16808 ], [ 2.87059, 43.16812 ], [ 2.87057, 43.16813 ], [ 2.87052, 43.16814 ], [ 2.87045, 43.16814 ], [ 2.8702, 43.16812 ], [ 2.86982, 43.1681 ], [ 2.86953, 43.16808 ], [ 2.8691, 43.168 ], [ 2.86889, 43.16796 ], [ 2.86886, 43.16795 ], [ 2.86863, 43.16793 ], [ 2.8684, 43.16788 ], [ 2.86825, 43.16783 ], [ 2.86834, 43.16774 ], [ 2.86845, 43.16767 ], [ 2.8685, 43.16764 ], [ 2.86855, 43.16761 ], [ 2.86864, 43.16755 ], [ 2.86882, 43.1676 ], [ 2.86866, 43.16755 ], [ 2.86856, 43.16751 ], [ 2.86847, 43.16745 ], [ 2.86843, 43.16741 ], [ 2.86841, 43.16739 ], [ 2.86829, 43.16726 ], [ 2.86808, 43.16696 ], [ 2.86804, 43.16691 ], [ 2.86802, 43.16687 ], [ 2.86801, 43.16685 ], [ 2.86801, 43.16684 ], [ 2.86802, 43.16682 ], [ 2.86803, 43.1668 ], [ 2.86805, 43.16679 ], [ 2.86807, 43.16678 ], [ 2.8681, 43.16676 ], [ 2.86812, 43.16675 ], [ 2.86816, 43.16674 ], [ 2.86818, 43.16672 ], [ 2.86821, 43.1667 ], [ 2.86822, 43.16668 ], [ 2.86824, 43.16665 ], [ 2.86824, 43.16661 ], [ 2.86822, 43.16654 ], [ 2.86819, 43.16651 ], [ 2.86813, 43.16643 ], [ 2.86793, 43.16621 ], [ 2.86761, 43.16589 ], [ 2.86754, 43.16585 ], [ 2.8675, 43.16583 ], [ 2.86745, 43.16581 ], [ 2.86739, 43.16583 ], [ 2.86734, 43.16584 ], [ 2.8673, 43.16584 ], [ 2.86726, 43.16582 ], [ 2.86722, 43.16581 ], [ 2.86718, 43.16577 ], [ 2.86715, 43.16573 ], [ 2.86712, 43.16566 ], [ 2.86707, 43.16549 ], [ 2.86708, 43.16504 ], [ 2.8671, 43.16462 ], [ 2.86745, 43.16437 ], [ 2.86772, 43.16418 ], [ 2.86779, 43.1641 ], [ 2.86763, 43.16403 ], [ 2.86762, 43.16402 ], [ 2.86761, 43.16402 ], [ 2.86742, 43.16393 ], [ 2.86723, 43.16379 ], [ 2.86717, 43.16374 ], [ 2.86718, 43.16356 ], [ 2.86724, 43.16356 ], [ 2.8673, 43.16354 ], [ 2.86741, 43.16349 ], [ 2.86765, 43.16331 ], [ 2.868, 43.16307 ], [ 2.8682, 43.16293 ], [ 2.86826, 43.16299 ], [ 2.8684, 43.16313 ], [ 2.86845, 43.16317 ], [ 2.86852, 43.16321 ], [ 2.8686, 43.16326 ], [ 2.86879, 43.16335 ], [ 2.86895, 43.16341 ], [ 2.86901, 43.16335 ], [ 2.86909, 43.16331 ], [ 2.86913, 43.16329 ], [ 2.86929, 43.16324 ], [ 2.86953, 43.16315 ], [ 2.86954, 43.16314 ], [ 2.86961, 43.16311 ], [ 2.86964, 43.16308 ], [ 2.86969, 43.16313 ], [ 2.86976, 43.16319 ], [ 2.86979, 43.16323 ], [ 2.87012, 43.16311 ], [ 2.87028, 43.16305 ], [ 2.87048, 43.16301 ], [ 2.87076, 43.16296 ], [ 2.87092, 43.16295 ], [ 2.87094, 43.16294 ], [ 2.87101, 43.16294 ], [ 2.87107, 43.16294 ], [ 2.87114, 43.16295 ], [ 2.8712, 43.16296 ], [ 2.87121, 43.16296 ], [ 2.87131, 43.16297 ] 
                              ] 
                    }
               }
            });
            
            map.addLayer({
                'id': 'route',
                'type': 'line',
                'source': 'route',
                'layout': {
                'line-join': 'round',
                'line-cap': 'round'
                },
                'paint': {
                'line-color': '#2057b5',
                'line-width': 5
                }
            });
    });
    

      // ZOOM
     // map.addControl(new mapboxgl.NavigationControl(), 'top-left'); // disable map zoom when using scroll
    //  map.scrollZoom.disable(); 
      
    // Add geolocate control to the map.
        map.addControl(
            new mapboxgl.GeolocateControl({
            positionOptions: {
            enableHighAccuracy: true
            },
            trackUserLocation: true
            })
        );
  </script>

  
<script>
function w3_open() {
  document.getElementById("mySidebar").style.display = "block";
}

function w3_close() {
  document.getElementById("mySidebar").style.display = "none";
}
  
function myFunction() {
  var popup = document.getElementById("myPopup");
  popup.classList.toggle("show");
}
</script>

<script>
$(document).ready(function(){
  $('[data-toggle="tooltip"]').tooltip();
});
</script>

<script>
var coll = document.getElementsByClassName("collapsible");
var i;

for (i = 0; i < coll.length; i++) {
  coll[i].addEventListener("click", function() {
    this.classList.toggle("active");
    var content = this.nextElementSibling;
    if (content.style.display === "block") {
      content.style.display = "none";
    } else {
      content.style.display = "block";
    }
  });
}
</script>
        {% include navbar.html %}
    
<content>
    {{ content }}
</content>
          
</body>

</html>